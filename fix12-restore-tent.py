import os, re
p = os.path.expanduser("~/Documents/GitHub/habitaris-suite/src/modules/CRM.jsx")
with open(p) as f: c = f.read()

changes = 0

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# 1. REPLACE current simplified TEnt with original full version
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

# Find current TEnt boundaries
m = re.search(r'function TEnt\(\{[^}]+\}\)\s*\{', c)
if not m:
    print("  âœ— TEnt function not found")
else:
    start = m.start()
    rest = c[start:]
    depth = 0
    end = start
    found = False
    for i, ch in enumerate(rest):
        if ch == '{':
            depth += 1
            found = True
        elif ch == '}':
            depth -= 1
            if found and depth == 0:
                end = start + i + 1
                break
    
    old_tent_code = 'function TEnt({ d, set, r }) {\n  const getText = (k, def) => d["ent_"+k] ?? def;\n  const setText = (k, v) => set("ent_"+k, v);\n  const isObra = d.tipoProyecto === "OBRA";\n  const condPct4 = d.condPct4 ?? 0.10;\n\n  /* textarea + print render */\n  const ta = (k, def, rows=3) => (<>\n    <textarea value={getText(k, def)} rows={rows}\n      onChange={e => setText(k, e.target.value)}\n      style={{ width:"100%", border:`1px solid ${C.border}`, borderRadius:4, padding:"8px 10px",\n        fontSize:12, fontFamily:"\'DM Sans\',sans-serif", resize:"vertical", lineHeight:1.5,\n        background:C.bg, color:C.ink }}/>\n    <div className="ptr" style={{ fontSize:12, lineHeight:1.6 }}>{getText(k, def)}</div>\n  </>);\n  const inp = (k, def) => (\n    <input value={getText(k, def)} onChange={e => setText(k, e.target.value)}\n      style={{ width:"100%", border:`1px solid ${C.border}`, borderRadius:4, padding:"7px 10px",\n        fontSize:13, fontFamily:"\'DM Sans\',sans-serif", background:C.bg, color:C.ink }}/>\n  );\n  const label = (text) => (\n    <p className="no-print" style={{ fontSize:9, fontWeight:600, color:C.inkLight, textTransform:"uppercase",\n      letterSpacing:1, margin:"0 0 5px" }}>{text}</p>\n  );\n  const plabel = (text) => (\n    <p style={{ fontSize:9, fontWeight:600, color:C.inkLight, textTransform:"uppercase",\n      letterSpacing:1, margin:"0 0 5px" }}>{text}</p>\n  );\n\n  const [nivelDetalle, setNivelDetalle] = useState(d.ent_nivelDetalle || "capitulos");\n  const onNivelChange = (v) => { setNivelDetalle(v); set("ent_nivelDetalle", v); };\n  const [inclCrono, setInclCrono] = useState(d.ent_inclCrono ?? false);\n  const [inclOrganigrama, setInclOrganigrama] = useState(d.ent_inclOrganigrama ?? false);\n  const onToggle = (k, v, setter) => { setter(v); set("ent_"+k, v); };\n\n  const borLineas = (d.borradorLineas||[]);\n  const capitulos = borLineas.filter(l => l.esCapitulo);\n  const capTotals = capitulos.map(cap => {\n    const capIdx = borLineas.indexOf(cap);\n    const nextCapIdx = borLineas.findIndex((l, i) => i > capIdx && l.esCapitulo);\n    const items = borLineas.slice(capIdx + 1, nextCapIdx === -1 ? borLineas.length : nextCapIdx).filter(l => !l.esCapitulo);\n    const total = items.reduce((s, l) => {\n      const v = l.precioCD ? calcPUVentaLinea(l.precioCD, l.cantidad||1, d) : null;\n      return s + (v ? v.totalVenta : 0);\n    }, 0);\n    return { ...cap, total, items };\n  });\n\n  const representante = d.firmaRepresentante || "David Parra Galera";\n  const cargo = representante === "Ana MarÃ­a DÃ­az Buitrago" ? "Directora Creativa y de DiseÃ±o" : "Director Ejecutivo y de ProducciÃ³n";\n\n  const titulo = getText("titulo", isObra ? "PRESUPUESTO DE EJECUCIÃ“N" : "PROPUESTA DE DISEÃ‘O");\n  const refOferta = getText("ref", d.codigoOferta || "");\n  const clienteNombre = getText("cliente", d.cliente || "");\n  const fechaDoc = getText("fecha", d.fechaOferta || today());\n  const revision = d.revision || 1;\n\n  /* â”€â”€ PDF download with proper filename â”€â”€ */\n  const downloadPDF = () => {\n    const parts = [refOferta, d.proyecto||"Habitaris", `Rev${revision}`].filter(Boolean);\n    const filename = parts.join("_").replace(/[^a-zA-Z0-9Ã¡Ã©Ã­Ã³ÃºÃ±ÃÃ‰ÃÃ“ÃšÃ‘_\\-]/g, "_");\n    document.title = filename;\n    window.print();\n    setTimeout(() => { document.title = "Habitaris Suite"; }, 1500);\n  };\n\n  /* â”€â”€ Apply service template â”€â”€ */\n  const applyTemplate = (tplId) => {\n    const T = {\n      obra_integral: {\n        titulo: "PRESUPUESTO DE EJECUCIÃ“N",\n        alcance: `El presente alcance comprende la ejecuciÃ³n integral del proyecto ${d.proyecto||""}, incluyendo:\\n\\n1. OBRA CIVIL: Demoliciones selectivas, mamposterÃ­a, paÃ±etes, nivelaciÃ³n de pisos y cielos.\\n2. INSTALACIONES: Red hidrosanitaria, red elÃ©ctrica y puntos de datos segÃºn planos tÃ©cnicos aprobados.\\n3. ACABADOS: Suministro e instalaciÃ³n de pisos, enchapes, pintura, carpinterÃ­a en madera y metÃ¡lica.\\n4. MOBILIARIO FIJO: Cocina integral, closets, muebles de baÃ±o y demÃ¡s mobiliario fijo segÃºn diseÃ±o.\\n5. SUPERVISIÃ“N: DirecciÃ³n de obra, control de calidad, coordinaciÃ³n de subcontratistas y proveedores.\\n\\nEl proyecto se ejecutarÃ¡ en la direcciÃ³n ${d.ubicacion||"___"} conforme a los diseÃ±os previamente aprobados por el cliente.`,\n        fases: "1. Firma de contrato y pago de anticipo\\n2. Acta de inicio de obra\\n3. Demoliciones y obra negra\\n4. Instalaciones tÃ©cnicas (hidrosanitaria, elÃ©ctrica, gas)\\n5. Obra gris (paÃ±etes, nivelaciÃ³n, impermeabilizaciÃ³n)\\n6. Acabados (pisos, enchapes, pintura)\\n7. CarpinterÃ­a y mobiliario fijo\\n8. Aseo final y entrega\\n9. Acta de recepciÃ³n y cierre",\n        exclusiones: "Esta propuesta NO incluye, salvo acuerdo escrito:\\n\\n- Licencias y permisos de construcciÃ³n\\n- Obra de estructura o cimentaciÃ³n no contemplada en diseÃ±os\\n- Suministro e instalaciÃ³n de electrodomÃ©sticos\\n- Mudanzas y trasteos\\n- DiseÃ±o o rediseÃ±o (ya aprobado previamente)\\n- Adecuaciones en zonas comunes del edificio\\n- Amoblamiento libre (sofÃ¡s, camas, mesas, sillas)\\n\\nTodos los entregables se comparten exclusivamente en formato digital.",\n        condPago: `Forma de pago:\\n\\n1. ${((d.condPct1||0.5)*100).toFixed(0)}% Anticipo contra firma de contrato\\n2. ${((d.condPct2||0.3)*100).toFixed(0)}% Contra avance del 50% de obra\\n3. ${((d.condPct3||0.1)*100).toFixed(0)}% Contra finalizaciÃ³n de obra\\n4. ${((condPct4)*100).toFixed(0)}% RetenciÃ³n de garantÃ­a (a 3 meses)`,\n        plazo: `El plazo de ejecuciÃ³n estimado es de ${d.plazoSemanas||12} semanas calendario contadas a partir del acta de inicio de obra.`,\n        garantias: "Habitaris garantiza los trabajos ejecutados por un perÃ­odo de 12 meses contados a partir del acta de entrega final:\\n\\n- Estabilidad y solidez de obra civil: 10 aÃ±os segÃºn Ley 1796 de 2016\\n- ImpermeabilizaciÃ³n: 5 aÃ±os\\n- Acabados y revestimientos: 1 aÃ±o\\n- Instalaciones hidrosanitarias y elÃ©ctricas: 1 aÃ±o\\n- CarpinterÃ­a y mobiliario fijo: 1 aÃ±o\\n\\nLa garantÃ­a no cubre daÃ±os por uso inadecuado, modificaciones del cliente o fuerza mayor.",\n      },\n      obra_parcial: {\n        titulo: "PRESUPUESTO DE EJECUCIÃ“N PARCIAL",\n        alcance: `El presente alcance comprende la ejecuciÃ³n parcial de obras en el proyecto ${d.proyecto||""}, limitado a las partidas descritas en el presupuesto adjunto.\\n\\nLos trabajos se realizarÃ¡n conforme a los planos y especificaciones tÃ©cnicas proporcionados por el cliente o su equipo de diseÃ±o.\\n\\nHabitaris actuarÃ¡ como ejecutor de las obras descritas, sin responsabilidad sobre el diseÃ±o ni sobre partidas no incluidas en esta propuesta.`,\n        fases: "1. Firma de contrato y pago de anticipo\\n2. ProgramaciÃ³n y alistamiento de obra\\n3. EjecuciÃ³n de partidas contratadas\\n4. Control de calidad y verificaciÃ³n\\n5. Entrega y acta de recepciÃ³n",\n        exclusiones: "Esta propuesta NO incluye:\\n\\n- DiseÃ±o arquitectÃ³nico o de interiores\\n- Partidas no listadas explÃ­citamente en el presupuesto\\n- Licencias, permisos o trÃ¡mites ante entidades\\n- InterventorÃ­a externa\\n- Suministro de electrodomÃ©sticos o amoblamiento\\n\\nCualquier trabajo adicional serÃ¡ cotizado por separado.",\n        condPago: `Forma de pago:\\n\\n1. ${((d.condPct1||0.5)*100).toFixed(0)}% Anticipo contra firma de contrato\\n2. ${((d.condPct2||0.3)*100).toFixed(0)}% Contra avance del 50%\\n3. ${((d.condPct3||0.1)*100).toFixed(0)}% Contra finalizaciÃ³n\\n4. ${((condPct4)*100).toFixed(0)}% RetenciÃ³n de garantÃ­a`,\n        plazo: `El plazo de ejecuciÃ³n estimado es de ${d.plazoSemanas||8} semanas calendario.`,\n        garantias: "GarantÃ­a de 12 meses sobre los trabajos ejecutados, contados desde el acta de entrega.",\n      },\n      diseno_int: {\n        titulo: "PROPUESTA DE DISEÃ‘O INTERIOR",\n        alcance: `DiseÃ±o interior integral del proyecto ${d.proyecto||""} ubicado en ${d.ubicacion||"___"}.\\n\\nEl servicio incluye:\\n\\n1. LEVANTAMIENTO: Visita tÃ©cnica, toma de medidas y registro fotogrÃ¡fico del estado actual.\\n2. CONCEPTUALIZACIÃ“N: Desarrollo de concepto de diseÃ±o, moodboards, paleta de materiales y colores.\\n3. DISEÃ‘O BÃSICO: Plantas de distribuciÃ³n, propuesta de mobiliario, iluminaciÃ³n general.\\n4. DISEÃ‘O DETALLADO: Planos tÃ©cnicos de construcciÃ³n (plantas, cortes, detalles), especificaciones de acabados, cuadros de cantidades.\\n5. RENDERS: Visualizaciones 3D de los espacios principales.\\n6. ACOMPAÃ‘AMIENTO: Seguimiento durante la ejecuciÃ³n de obra.`,\n        fases: "1. Firma de contrato y anticipo\\n2. Levantamiento y mediciones\\n3. Concepto de diseÃ±o y moodboard\\n4. PresentaciÃ³n de diseÃ±o bÃ¡sico\\n5. AprobaciÃ³n del cliente\\n6. Desarrollo de planos tÃ©cnicos\\n7. Entrega de planos y especificaciones\\n8. AcompaÃ±amiento en obra (si aplica)",\n        exclusiones: "Esta propuesta NO incluye:\\n\\n- EjecuciÃ³n de obra civil o instalaciones\\n- Suministro o compra de materiales, mobiliario o equipos\\n- DiseÃ±o estructural o de ingenierÃ­a especializada\\n- Renders adicionales a los incluidos\\n- TrÃ¡mites de licencias urbanÃ­sticas\\n- InterventorÃ­a de obra\\n\\nTodos los entregables se comparten en formato digital.",\n        condPago: `Forma de pago:\\n\\n1. 50% Anticipo contra firma de contrato\\n2. 30% Contra entrega de diseÃ±o bÃ¡sico aprobado\\n3. 20% Contra entrega de planos tÃ©cnicos finales`,\n        plazo: `El plazo de desarrollo es de ${d.plazoSemanas||6} semanas a partir de la aprobaciÃ³n del concepto.`,\n        garantias: "Los entregables de diseÃ±o se entregan en formato digital editable. Se incluyen hasta 2 rondas de ajustes por etapa. Modificaciones adicionales se cotizarÃ¡n por separado.",\n      },\n      diseno_arq: {\n        titulo: "PROPUESTA DE DISEÃ‘O ARQUITECTÃ“NICO",\n        alcance: `DiseÃ±o arquitectÃ³nico del proyecto ${d.proyecto||""} ubicado en ${d.ubicacion||"___"}.\\n\\n1. ESQUEMA BÃSICO: AnÃ¡lisis del programa, zonificaciÃ³n, volumetrÃ­a.\\n2. ANTEPROYECTO: Plantas, fachadas, cortes y perspectivas.\\n3. PROYECTO: Planos definitivos, detalles constructivos, memorias.\\n4. COORDINACIÃ“N: IntegraciÃ³n con ingenierÃ­as.`,\n        fases: "1. Visita al sitio y levantamiento\\n2. Programa arquitectÃ³nico\\n3. Esquema bÃ¡sico\\n4. Anteproyecto\\n5. Proyecto definitivo\\n6. CoordinaciÃ³n tÃ©cnica\\n7. Entrega final",\n        exclusiones: "NO incluye estudios de suelos, topografÃ­a, diseÃ±o estructural, hidrosanitario, elÃ©ctrico, licencias de construcciÃ³n ni ejecuciÃ³n de obra.",\n        condPago: "1. 40% Anticipo\\n2. 30% Contra entrega de anteproyecto\\n3. 30% Contra entrega de proyecto definitivo",\n        plazo: `Plazo estimado: ${d.plazoSemanas||8} semanas.`,\n        garantias: "Entregables en formato digital. 2 rondas de ajustes incluidas por etapa.",\n      },\n      consultoria: {\n        titulo: "PROPUESTA DE CONSULTORÃA",\n        alcance: `ConsultorÃ­a especializada para el proyecto ${d.proyecto||""}.\\n\\n1. DiagnÃ³stico y anÃ¡lisis del estado actual\\n2. Propuesta de intervenciÃ³n con alternativas\\n3. EstimaciÃ³n presupuestal\\n4. Informe tÃ©cnico con recomendaciones\\n5. AcompaÃ±amiento en la toma de decisiones`,\n        fases: "1. ReuniÃ³n de inicio\\n2. Visita tÃ©cnica\\n3. AnÃ¡lisis y diagnÃ³stico\\n4. PresentaciÃ³n de alternativas\\n5. Informe final",\n        exclusiones: "NO incluye desarrollo de planos tÃ©cnicos, ejecuciÃ³n de obras ni compra de materiales.",\n        condPago: "1. 50% Anticipo\\n2. 50% Contra entrega de informe final",\n        plazo: `Plazo estimado: ${d.plazoSemanas||4} semanas.`,\n        garantias: "Informe entregado en formato digital.",\n      },\n      custom: { titulo:"", alcance:"", fases:"", exclusiones:"", condPago:"", plazo:"", garantias:"" },\n    };\n    const t = T[tplId];\n    if (!t) return;\n    if (t.titulo) setText("titulo", t.titulo);\n    setText("alcance", t.alcance);\n    setText("fases", t.fases);\n    setText("exclusiones", t.exclusiones);\n    if (t.condPago) setText("condPago", t.condPago);\n    if (t.plazo) setText("plazo", t.plazo);\n    if (t.garantias) setText("garantias", t.garantias);\n  };\n\n  /* â”€â”€ Vista previa profesional (new window) â”€â”€ */\n  const printEntregaPreview = () => {\n    const w = window.open("","_blank");\n    const S = `@import url(\'https://fonts.googleapis.com/css2?family=DM Sans:wght@300;400;600;700;800&family=DM+Mono:wght@400;500&display=swap\');\n    @page{size:A4 portrait;margin:15mm 18mm}\n    *{margin:0;padding:0;box-sizing:border-box}\n    body{font-family:\'DM Sans\',sans-serif;color:#1A1A1A;font-size:10px;line-height:1.6}\n    .cover{min-height:100vh;display:flex;flex-direction:column;justify-content:space-between;padding:40px 50px;page-break-after:always}\n    .cover-brand{border-bottom:3px solid #111;padding-bottom:16px}\n    .cover-brand h1{font-size:36px;font-weight:800;letter-spacing:10px;text-transform:uppercase}\n    .cover-brand p{font-size:8px;letter-spacing:3px;color:#888;text-transform:uppercase;margin-top:4px}\n    .cover-title{margin:80px 0}\n    .cover-title h2{font-size:26px;font-weight:700;letter-spacing:3px;text-transform:uppercase;line-height:1.3;color:#111}\n    .cover-title .ref{font-size:13px;color:#666;margin-top:10px}\n    .cover-info{font-size:12px;color:#444;line-height:2}\n    .cover-info strong{color:#111}\n    .cover-footer{border-top:1px solid #DDD;padding-top:16px;text-align:center}\n    .cover-footer p{font-size:8px;color:#999;letter-spacing:1px}\n    .toc{padding:40px 50px;page-break-after:always}\n    .toc h2{font-size:18px;font-weight:700;letter-spacing:3px;text-transform:uppercase;border-bottom:3px solid #111;padding-bottom:8px;margin-bottom:24px}\n    .toc-item{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px dotted #CCC;font-size:12px}\n    .toc-item span:first-child{font-weight:600}\n    .toc-item span:last-child{font-family:\'DM Mono\',monospace;color:#888;font-size:10px}\n    .page{padding:30px 50px;page-break-after:always;min-height:90vh}\n    .page-header{display:flex;justify-content:space-between;align-items:flex-end;padding-bottom:8px;border-bottom:2px solid #111;margin-bottom:20px}\n    .page-header .brand{font-weight:700;font-size:12px;letter-spacing:4px}\n    .page-header .meta{text-align:right;font-size:8px;color:#666}\n    .section-title{font-size:16px;font-weight:700;letter-spacing:1px;color:#111;margin:20px 0 10px;padding-bottom:4px;border-bottom:1px solid #E0E0E0}\n    .section-num{color:#888;font-weight:400;margin-right:8px}\n    .content{font-size:11px;line-height:1.8;color:#333;white-space:pre-wrap}\n    table{width:100%;border-collapse:collapse;margin:10px 0}\n    th{background:#F5F4F1;padding:8px 12px;font-size:8px;font-weight:700;color:#888;text-transform:uppercase;letter-spacing:.5px;text-align:left;border-bottom:2px solid #DDD}\n    td{padding:7px 12px;font-size:10px;border-bottom:1px solid #F5F5F5}\n    .mono{font-family:\'DM Mono\',monospace}\n    .r{text-align:right}\n    .bold{font-weight:700}\n    .total-row{background:#111;color:#fff}\n    .total-row td{color:#fff;font-weight:700;font-size:12px;padding:10px 12px}\n    .iva-row{background:#F5F4F1}\n    .sign-block{margin-top:40px;display:grid;grid-template-columns:1fr 1fr;gap:40px}\n    .sign-box{text-align:center;padding-top:40px;border-top:1px solid #111}\n    .sign-box .name{font-size:11px;font-weight:700}\n    .sign-box .role{font-size:9px;color:#666}\n    .doc-footer{position:fixed;bottom:10mm;left:18mm;right:18mm;display:flex;justify-content:space-between;font-size:7px;color:#AAA;border-top:1px solid #E0E0E0;padding-top:4px}`;\n\n    const hdr = `<div class="page-header"><div class="brand">HABITARIS</div><div class="meta"><div>${titulo}</div><div>${refOferta} Â· Rev.${revision} Â· ${fechaDoc}</div></div></div>`;\n    const nl2p = (txt) => (txt||"").split("\\n").map(l=>l.trim()).filter(Boolean).map(l=>`<p>${l}</p>`).join("");\n\n    let html = `<html><head><title>${refOferta} - ${d.proyecto||"Habitaris"}</title><style>${S}</style></head><body>`;\n\n    // â”€â”€ COVER PAGE â”€â”€\n    html += `<div class="cover">`;\n    html += `<div class="cover-brand"><h1>HABITARIS</h1><p>Arquitectura Â· Interiorismo Â· ConstrucciÃ³n</p></div>`;\n    html += `<div class="cover-title"><h2>${titulo}</h2>`;\n    html += `<div class="ref">${refOferta} Â· RevisiÃ³n ${revision}</div></div>`;\n    html += `<div class="cover-info">`;\n    if(clienteNombre) html += `<div><strong>Cliente:</strong> ${clienteNombre}</div>`;\n    if(d.proyecto) html += `<div><strong>Proyecto:</strong> ${d.proyecto}</div>`;\n    if(d.ubicacion) html += `<div><strong>UbicaciÃ³n:</strong> ${d.ubicacion}</div>`;\n    html += `<div><strong>Fecha:</strong> ${fechaDoc}</div>`;\n    html += `<div><strong>Vigencia:</strong> 30 dÃ­as calendario</div></div>`;\n    html += `<div class="cover-footer"><p>Habitaris S.A.S Â· NIT 901.922.136-8 Â· BogotÃ¡ D.C.</p><p>Documento confidencial Â· Uso exclusivo del destinatario</p></div>`;\n    html += `</div>`;\n\n    // â”€â”€ TABLE OF CONTENTS â”€â”€\n    let secNum = 0;\n    const secs = [];\n    secs.push("Alcance del servicio");\n    if(isObra) secs.push("Fases del proyecto");\n    secs.push("Exclusiones");\n    secs.push("Presupuesto");\n    if(d.ent_inclCondPago !== false) secs.push("Condiciones de pago");\n    if(d.ent_inclGarantias !== false) secs.push("Plazo y garantÃ­as");\n    secs.push("TÃ©rminos y condiciones");\n    secs.push("Firma de aceptaciÃ³n");\n\n    html += `<div class="toc"><h2>Contenido</h2>`;\n    secs.forEach((s,i) => { html += `<div class="toc-item"><span>${i+1}. ${s}</span><span>${i+2}</span></div>`; });\n    html += `</div>`;\n\n    // â”€â”€ ALCANCE â”€â”€\n    html += `<div class="page">${hdr}`;\n    secNum++;\n    html += `<div class="section-title"><span class="section-num">${secNum}.</span>Alcance del servicio</div>`;\n    html += `<div class="content">${getText("alcance","")}</div>`;\n\n    // FASES\n    if(isObra) {\n      secNum++;\n      html += `<div class="section-title"><span class="section-num">${secNum}.</span>Fases del proyecto</div>`;\n      html += `<div class="content">${getText("fases","")}</div>`;\n    }\n\n    // EXCLUSIONES\n    secNum++;\n    html += `<div class="section-title"><span class="section-num">${secNum}.</span>Exclusiones</div>`;\n    html += `<div class="content">${getText("exclusiones","")}</div>`;\n    html += `</div>`;\n\n    // â”€â”€ PRESUPUESTO â”€â”€\n    html += `<div class="page">${hdr}`;\n    secNum++;\n    html += `<div class="section-title"><span class="section-num">${secNum}.</span>Presupuesto</div>`;\n\n    if(nivelDetalle === "total") {\n      html += `<table><thead><tr><th>Item</th><th>DescripciÃ³n</th><th class="r">Valor</th></tr></thead><tbody>`;\n      html += `<tr><td>1</td><td>${getText("descTotal",d.proyecto||"Proyecto")}</td><td class="mono r bold">${fmt(r.PVP)}</td></tr>`;\n      html += `<tr class="iva-row"><td colspan="2">${isObra?"IVA sobre la utilidad":`IVA ${pct(d.tarifaIVA)}`}</td><td class="mono r">${fmt(r.IVA)}</td></tr>`;\n      html += `<tr class="total-row"><td colspan="2">VALOR TOTAL</td><td class="mono r">${fmt(r.PVP_IVA)}</td></tr>`;\n      html += `</tbody></table>`;\n    } else if(nivelDetalle === "capitulos") {\n      html += `<table><thead><tr><th>Item</th><th>DescripciÃ³n</th><th class="r">Total</th></tr></thead><tbody>`;\n      capTotals.forEach((cap,i) => {\n        html += `<tr><td class="bold">${i+1}</td><td class="bold">${cap.nombre||"CapÃ­tulo "+(i+1)}</td><td class="mono r bold">${fmt(cap.total)}</td></tr>`;\n      });\n      html += `<tr style="border-top:2px solid #111;background:#FFFFFF"><td colspan="2" class="bold">Subtotal</td><td class="mono r bold">${fmt(r.PVP)}</td></tr>`;\n      html += `<tr class="iva-row"><td colspan="2">${isObra?"IVA sobre la utilidad":`IVA ${pct(d.tarifaIVA)}`}</td><td class="mono r">${fmt(r.IVA)}</td></tr>`;\n      html += `<tr class="total-row"><td colspan="2">VALOR TOTAL</td><td class="mono r">${fmt(r.PVP_IVA)}</td></tr>`;\n      html += `</tbody></table>`;\n    } else {\n      html += `<table><thead><tr><th>#</th><th>DescripciÃ³n</th><th class="r">Und</th><th class="r">Cant</th><th class="r">P.U.</th><th class="r">Total</th></tr></thead><tbody>`;\n      capTotals.forEach((cap,ci) => {\n        html += `<tr style="background:#F5F4F1"><td class="bold" colspan="5">${ci+1}. ${cap.nombre||""}</td><td class="mono r bold">${fmt(cap.total)}</td></tr>`;\n        (cap.items||[]).forEach((it,ii) => {\n          const v = it.precioCD ? calcPUVentaLinea(it.precioCD, it.cantidad||1, d) : null;\n          html += `<tr><td>${ci+1}.${ii+1}</td><td>${it.descripcion||""}</td><td class="r">${it.und||"ud"}</td>`;\n          html += `<td class="mono r">${it.cantidad||1}</td><td class="mono r">${v?fmt(v.puVenta):"â€”"}</td><td class="mono r">${v?fmt(v.totalVenta):"â€”"}</td></tr>`;\n        });\n      });\n      html += `<tr style="border-top:2px solid #111;background:#FFFFFF"><td colspan="5" class="bold">Subtotal</td><td class="mono r bold">${fmt(r.PVP)}</td></tr>`;\n      html += `<tr class="iva-row"><td colspan="5">${isObra?"IVA sobre la utilidad":`IVA ${pct(d.tarifaIVA)}`}</td><td class="mono r">${fmt(r.IVA)}</td></tr>`;\n      html += `<tr class="total-row"><td colspan="5">VALOR TOTAL</td><td class="mono r">${fmt(r.PVP_IVA)}</td></tr>`;\n      html += `</tbody></table>`;\n    }\n\n    html += `<div style="margin-top:16px;padding:10px 14px;background:#F5F4F1;border-radius:4px;font-size:9px;color:#666">`;\n    html += `Valores expresados en ${d.divisa||"COP"}. ${isObra?"IVA calculado sobre la utilidad segÃºn normativa colombiana.":"IVA incluido segÃºn tarifa vigente."} Propuesta vÃ¡lida por 30 dÃ­as calendario.</div>`;\n    html += `</div>`;\n\n    // â”€â”€ CONDICIONES DE PAGO â”€â”€\n    if(d.ent_inclCondPago !== false) {\n      html += `<div class="page">${hdr}`;\n      secNum++;\n      html += `<div class="section-title"><span class="section-num">${secNum}.</span>Condiciones de pago</div>`;\n      html += `<div class="content">${getText("condPago","")}</div>`;\n    }\n\n    // â”€â”€ PLAZO Y GARANTÃAS â”€â”€\n    if(d.ent_inclGarantias !== false) {\n      if(d.ent_inclCondPago === false) html += `<div class="page">${hdr}`;\n      secNum++;\n      html += `<div class="section-title"><span class="section-num">${secNum}.</span>Plazo y garantÃ­as</div>`;\n      html += `<div class="content">${getText("plazo","")}</div>`;\n      html += `<div style="margin-top:10px" class="content">${getText("garantias","")}</div>`;\n    }\n\n    // â”€â”€ TÃ‰RMINOS â”€â”€\n    secNum++;\n    html += `<div class="section-title"><span class="section-num">${secNum}.</span>TÃ©rminos y condiciones</div>`;\n    html += `<div class="content">${getText("terminos","Los precios incluyen materiales, mano de obra, herramienta y administraciÃ³n segÃºn lo descrito en el alcance.\\n\\nCualquier trabajo no contemplado en esta propuesta se cotizarÃ¡ como adicional previo a su ejecuciÃ³n y deberÃ¡ ser aprobado por escrito.\\n\\nEl cronograma propuesto podrÃ¡ ajustarse por causas de fuerza mayor, cambios solicitados por el cliente o condiciones no previstas del inmueble.")}</div>`;\n    if(d.ent_inclCondPago !== false || d.ent_inclGarantias !== false) html += `</div>`;\n\n    // â”€â”€ FIRMA â”€â”€\n    html += `<div class="page">${hdr}`;\n    secNum++;\n    html += `<div class="section-title"><span class="section-num">${secNum}.</span>Firma de aceptaciÃ³n</div>`;\n    html += `<div style="font-size:11px;line-height:1.8;color:#333;margin:16px 0 30px">`;\n    html += `Con la firma del presente documento, el Cliente acepta los tÃ©rminos y condiciones descritos en esta propuesta, `;\n    html += `y autoriza a Habitaris S.A.S. a proceder con la ejecuciÃ³n del servicio de acuerdo al alcance, presupuesto y plazos aquÃ­ establecidos.</div>`;\n\n    html += `<div class="sign-block">`;\n    html += `<div class="sign-box"><div class="name">${representante}</div><div class="role">${cargo}</div><div style="font-size:8px;color:#888;margin-top:2px">Habitaris S.A.S. Â· NIT 901.922.136-8</div></div>`;\n    html += `<div class="sign-box"><div class="name">${clienteNombre || "________________________"}</div><div class="role">Cliente</div><div style="font-size:8px;color:#888;margin-top:2px">Firma y fecha de aceptaciÃ³n</div></div>`;\n    html += `</div>`;\n\n    html += `<div style="margin-top:40px;padding:14px;background:#F5F4F1;border-radius:4px;font-size:9px;color:#666;text-align:center">`;\n    html += `Habitaris S.A.S. Â· NIT 901.922.136-8 Â· BogotÃ¡ D.C., Colombia<br/>`;\n    html += `info@habitaris.co Â· +57 318 381 8736 Â· www.habitaris.co</div>`;\n    html += `</div>`;\n\n    html += `</body></html>`;\n    w.document.write(html); w.document.close();\n    setTimeout(() => w.print(), 500);\n  };\n\n  /* â”€â”€ WORKFLOW DE APROBACIÃ“N â”€â”€ */\n  const [wfHistory, setWfHistory] = useState([]);\n  const [wfPortals, setWfPortals] = useState([]);\n  const [wfLoading, setWfLoading] = useState(true);\n  const [wfComment, setWfComment] = useState("");\n  const [wfUsuario, setWfUsuario] = useState(d.wf_usuario || "david");\n\n  // Load workflow data\n  useEffect(() => {\n    (async () => {\n      if (!d.id) { setWfLoading(false); return; }\n      const [hist, ports] = await Promise.all([\n        aprobaciones.getByOferta(d.id),\n        portal.getByOferta(d.id),\n      ]);\n      setWfHistory(hist);\n      setWfPortals(ports);\n      setWfLoading(false);\n    })();\n  }, [d.id]);\n\n  // Current workflow state\n  const wfEstado = useMemo(() => {\n    if (wfHistory.length === 0) return "borrador";\n    const last = wfHistory[wfHistory.length - 1];\n    if (last.accion === "solicitar") return "pendiente_aprobacion";\n    if (last.accion === "aprobar_interno") return "aprobada_internamente";\n    if (last.accion === "devolver_interno") return "devuelta_internamente";\n    if (last.accion === "enviar") return "enviada";\n    if (last.accion === "aprobar_cliente") return "aprobada_cliente";\n    if (last.accion === "rechazar_cliente") return "rechazada_cliente";\n    if (last.accion === "devolver_cliente") return "devuelta_cliente";\n    if (last.accion === "reenviar") return "enviada";\n    return "borrador";\n  }, [wfHistory]);\n\n  const wfElaborador = USUARIOS_INTERNOS.find(u => u.id === wfUsuario);\n  const wfAprobador = (() => {\n    if (wfUsuario === "david") return USUARIOS_INTERNOS.find(u => u.id === "ana");\n    if (wfUsuario === "ana") return USUARIOS_INTERNOS.find(u => u.id === "david");\n    // Si es otro, aprueba el de la firma\n    const firmante = d.firmaRepresentante || "David Parra Galera";\n    return USUARIOS_INTERNOS.find(u => u.nombre === firmante) || USUARIOS_INTERNOS[0];\n  })();\n\n  // Actions\n  const wfAction = async (accion, extra = {}) => {\n    const entry = await aprobaciones.add({\n      ofertaId: d.id,\n      tipo: accion.includes("cliente") ? "cliente" : "interna",\n      revision,\n      accion,\n      por: { id: wfUsuario, nombre: wfElaborador?.nombre || wfUsuario, cargo: wfElaborador?.cargo || "" },\n      comentarios: wfComment,\n      ...extra,\n    });\n    setWfHistory(prev => [...prev, entry]);\n    setWfComment("");\n\n    // Auto-update offer estado\n    if (accion === "aprobar_cliente") set("estado", "Ganada");\n    if (accion === "rechazar_cliente") set("estado", "Perdida");\n    if (accion === "enviar" || accion === "reenviar") set("estado", "Presentada");\n    if (accion === "solicitar") set("estado", "En revisiÃ³n");\n\n    // Notification\n    if (accion === "solicitar") {\n      await notificaciones.add({ tipo:"aprobacion", ofertaId:d.id, mensaje:`${wfElaborador?.nombre} solicita aprobaciÃ³n de ${refOferta}`, para:wfAprobador?.id });\n    }\n  };\n\n\n  const wfEnviarCliente = async () => {\n    const portalData = {\n      ref: refOferta, titulo, cliente: clienteNombre, proyecto: d.proyecto||"",\n      ubicacion: d.ubicacion||"", fecha: fechaDoc, revision,\n      pvp: r.PVP, pvpIva: r.PVP_IVA, iva: r.IVA, divisa: d.divisa||"COP",\n      alcance: getText("alcance",""), fases: getText("fases",""),\n      exclusiones: getText("exclusiones",""), condPago: getText("condPago",""),\n      plazo: getText("plazo",""), garantias: getText("garantias",""),\n      terminos: getText("terminos",""), notaLegal: getText("notaLegal",""),\n      firmante: representante,\n      clienteEmail: d.emailCliente||"", telHabitaris: "573183818736",\n    };\n    const parentToken = d.wf_lastPortalToken || null;\n    const p = await createOfferPortal(d.id, portalData, revision, parentToken);\n    setWfPortals(prev => [...prev, p]);\n    await wfAction("enviar", { portalToken: p.token });\n    set("wf_lastPortalUrl", p.portalUrl);\n    set("wf_lastPortalToken", p.token);\n    return p;\n  };\n  const WF_ESTADOS = {\n    borrador:              { label:"Borrador",               color:"#888",    icon:"ğŸ“", desc:"En elaboraciÃ³n" },\n    pendiente_aprobacion:  { label:"Pendiente aprobaciÃ³n",   color:"#D4840A", icon:"â³", desc:`Esperando aprobaciÃ³n de ${wfAprobador?.nombre||"â€”"}` },\n    devuelta_internamente: { label:"Devuelta con cambios",   color:"#B91C1C", icon:"ğŸ”„", desc:"Requiere correcciones antes de aprobar" },\n    aprobada_internamente: { label:"Aprobada internamente",  color:"#111111", icon:"âœ…", desc:"Lista para enviar al cliente" },\n    enviada:               { label:"Enviada al cliente",     color:"#3B3B3B", icon:"ğŸ“¨", desc:"Esperando respuesta del cliente" },\n    aprobada_cliente:      { label:"Aprobada por cliente",   color:"#111111", icon:"ğŸ‰", desc:"Â¡Oferta ganada!" },\n    rechazada_cliente:     { label:"Rechazada por cliente",  color:"#B91C1C", icon:"âŒ", desc:"Cliente rechazÃ³ la propuesta" },\n    devuelta_cliente:      { label:"Devuelta por cliente",   color:"#D4840A", icon:"ğŸ’¬", desc:"Cliente solicita cambios" },\n  };\n  const wfInfo = WF_ESTADOS[wfEstado] || WF_ESTADOS.borrador;\n\n  return (\n    <div className="fade">\n\n      {/* â•â•â•â•â•â•â•â•â•â•â• COVER PAGE (print only) â•â•â•â•â•â•â•â•â•â•â• */}\n      <div className="p-cover">\n        <div style={{ borderBottom:"2pt solid #111", paddingBottom:16, marginBottom:40, width:"100%" }}>\n          <div style={{ fontFamily:"\'DM Sans\',sans-serif", fontWeight:800, fontSize:32, letterSpacing:8, textTransform:"uppercase" }}>HABITARIS</div>\n          <div style={{ fontSize:9, letterSpacing:3, color:"#999", textTransform:"uppercase", marginTop:4 }}>Arquitectura Â· Interiorismo Â· ConstrucciÃ³n</div>\n        </div>\n        <div style={{ marginTop:60, marginBottom:60 }}>\n          <div style={{ fontSize:22, fontWeight:700, letterSpacing:2, textTransform:"uppercase", lineHeight:1.3 }}>{titulo}</div>\n          {refOferta && <div style={{ fontSize:13, color:"#666", marginTop:8 }}>{refOferta} Â· RevisiÃ³n {revision}</div>}\n        </div>\n        <div style={{ marginTop:40, fontSize:12, color:"#555", lineHeight:1.8 }}>\n          {clienteNombre && <div><strong>Cliente:</strong> {clienteNombre}</div>}\n          {d.proyecto && <div><strong>Proyecto:</strong> {d.proyecto}</div>}\n          {d.ubicacion && <div><strong>UbicaciÃ³n:</strong> {d.ubicacion}</div>}\n          <div><strong>Fecha:</strong> {fechaDoc}</div>\n        </div>\n        <div style={{ marginTop:"auto", paddingTop:60, borderTop:"1pt solid #DDD", width:"100%", textAlign:"center" }}>\n          <div style={{ fontSize:9, color:"#999", letterSpacing:1 }}>Habitaris S.A.S Â· NIT 901.922.136-8 Â· BogotÃ¡ D.C.</div>\n          <div style={{ fontSize:8, color:"#BBB", marginTop:4 }}>Documento confidencial Â· Uso exclusivo del destinatario</div>\n        </div>\n      </div>\n\n      {/* â•â•â•â•â•â•â•â•â•â•â• TABLE OF CONTENTS (print only) â•â•â•â•â•â•â•â•â•â•â• */}\n      <div className="print-only print-page-break" style={{ paddingTop:20 }}>\n        <div style={{ fontSize:16, fontWeight:700, letterSpacing:2, textTransform:"uppercase", borderBottom:"2pt solid #111", paddingBottom:6, marginBottom:20 }}>Contenido</div>\n        <div style={{ fontSize:11, lineHeight:2.2 }}>\n          <div style={{ display:"flex", justifyContent:"space-between", borderBottom:"1px dotted #CCC", padding:"2px 0" }}><span style={{ fontWeight:600 }}>1. Alcance del servicio</span></div>\n          {isObra && <div style={{ display:"flex", justifyContent:"space-between", borderBottom:"1px dotted #CCC", padding:"2px 0" }}><span style={{ fontWeight:600 }}>2. Fases del proyecto</span></div>}\n          <div style={{ display:"flex", justifyContent:"space-between", borderBottom:"1px dotted #CCC", padding:"2px 0" }}><span style={{ fontWeight:600 }}>{isObra?"3":"2"}. Exclusiones</span></div>\n          <div style={{ display:"flex", justifyContent:"space-between", borderBottom:"1px dotted #CCC", padding:"2px 0" }}><span style={{ fontWeight:600 }}>{isObra?"4":"3"}. Presupuesto</span></div>\n          <div style={{ display:"flex", justifyContent:"space-between", borderBottom:"1px dotted #CCC", padding:"2px 0" }}><span style={{ fontWeight:600 }}>{isObra?"5":"4"}. Formas de pago</span></div>\n          <div style={{ display:"flex", justifyContent:"space-between", borderBottom:"1px dotted #CCC", padding:"2px 0" }}><span style={{ fontWeight:600 }}>{isObra?"6":"5"}. Plazo y garantÃ­as</span></div>\n          <div style={{ display:"flex", justifyContent:"space-between", borderBottom:"1px dotted #CCC", padding:"2px 0" }}><span style={{ fontWeight:600 }}>{isObra?"7":"6"}. TÃ©rminos y condiciones</span></div>\n          <div style={{ display:"flex", justifyContent:"space-between", borderBottom:"1px dotted #CCC", padding:"2px 0" }}><span style={{ fontWeight:600 }}>{isObra?"8":"7"}. Firma de aceptaciÃ³n</span></div>\n        </div>\n      </div>\n\n      {/* â•â•â•â•â•â•â•â•â•â•â• PRINT HEADER (repeats each section) â•â•â•â•â•â•â•â•â•â•â• */}\n      {/* We\'ll insert a header-like div before each section for print */}\n\n      {/* â•â•â•â•â•â•â•â•â•â•â• TOOLBAR (no-print) â•â•â•â•â•â•â•â•â•â•â• */}\n      <Card className="no-print" style={{ padding:0, marginBottom:16, overflow:"hidden" }}>\n        {/* Row 1: Service Template Selector */}\n        <div style={{ padding:"14px 20px", background:"#F5F4F1", borderBottom:`1px solid ${C.border}` }}>\n          <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", flexWrap:"wrap", gap:10 }}>\n            <div>\n              <div style={{ fontSize:9, fontWeight:700, color:"#888", textTransform:"uppercase", letterSpacing:1, marginBottom:4 }}>Plantilla del servicio</div>\n              <div style={{ display:"flex", gap:0 }}>\n                {[\n                  { id:"obra_integral", lbl:"ğŸ—ï¸ Obra integral", tipo:"OBRA" },\n                  { id:"obra_parcial",  lbl:"ğŸ”¨ Obra parcial", tipo:"OBRA" },\n                  { id:"diseno_int",    lbl:"ğŸ¨ DiseÃ±o interior", tipo:"DISEÃ‘O" },\n                  { id:"diseno_arq",    lbl:"ğŸ“ DiseÃ±o arquitectÃ³nico", tipo:"DISEÃ‘O" },\n                  { id:"consultoria",   lbl:"ğŸ’¼ ConsultorÃ­a" },\n                  { id:"custom",        lbl:"ğŸ“„ En blanco" },\n                ].map((pl,i,arr) => {\n                  const active = d.ent_plantilla === pl.id;\n                  return (\n                    <button key={pl.id} onClick={() => {\n                      set("ent_plantilla", pl.id);\n                      applyTemplate(pl.id);\n                    }}\n                      style={{ padding:"7px 14px", fontSize:10, fontWeight:600, cursor:"pointer",\n                        border:`1px solid ${active?"#111111":C.border}`, borderLeft:i>0?"none":undefined,\n                        fontFamily:"\'DM Sans\',sans-serif", whiteSpace:"nowrap",\n                        borderRadius:i===0?"5px 0 0 5px":i===arr.length-1?"0 5px 5px 0":"0",\n                        background:active?"#111111":"#fff",\n                        color:active?"#fff":C.ink }}>\n                      {pl.lbl}\n                    </button>\n                  );\n                })}\n              </div>\n            </div>\n            <button onClick={printEntregaPreview}\n              style={{ padding:"8px 18px", background:"#111", color:"#fff", border:"none", borderRadius:5,\n                fontSize:11, fontWeight:600, cursor:"pointer", fontFamily:"\'DM Sans\',sans-serif",\n                display:"flex", alignItems:"center", gap:6 }}>\n              <FileText size={12}/> Vista previa PDF\n            </button>\n          </div>\n        </div>\n        {/* Row 2: Detail level + includes */}\n        <div style={{ padding:"12px 20px", display:"flex", justifyContent:"space-between", alignItems:"center", flexWrap:"wrap", gap:10 }}>\n          <div>\n            <label style={{ fontSize:9, fontWeight:600, color:"#999", textTransform:"uppercase", letterSpacing:1, display:"block", marginBottom:4 }}>Nivel de detalle presupuesto</label>\n            <div style={{ display:"flex", gap:0 }}>\n              {[["detallado","Detallado"],["capitulos","Por capÃ­tulos"],["total","Total Ãºnico"]].map(([k,lbl],i)=>(\n                <button key={k} onClick={()=>onNivelChange(k)}\n                  style={{ padding:"6px 14px", fontSize:11, fontWeight:600, cursor:"pointer",\n                    border:`1px solid ${C.border}`, fontFamily:"\'DM Sans\',sans-serif",\n                    borderRadius: k==="detallado"?"5px 0 0 5px":k==="total"?"0 5px 5px 0":"0",\n                    borderLeft:i>0?"none":undefined,\n                    background:nivelDetalle===k?"#111":"#fff",\n                    color:nivelDetalle===k?"#fff":"#555" }}>{lbl}</button>\n              ))}\n            </div>\n          </div>\n          <div style={{ display:"flex", gap:16, flexWrap:"wrap", alignItems:"center" }}>\n            {[["inclCrono", inclCrono, setInclCrono, "ğŸ“… Incluir cronograma"],\n              ["inclOrganigrama", inclOrganigrama, setInclOrganigrama, "ğŸ‘¥ Incluir organigrama"],\n            ].map(([k, val, setter, lbl]) => (\n              <label key={k} style={{ display:"flex", alignItems:"center", gap:6, cursor:"pointer", fontSize:11,\n                padding:"5px 10px", borderRadius:4, background:val?"#E8F4EE":"#F5F4F1",\n                border:`1px solid ${val?"#111111":"transparent"}` }}>\n                <input type="checkbox" checked={val} onChange={e => onToggle(k, e.target.checked, setter)}\n                  style={{ accentColor:"#111111" }} />\n                <span style={{ fontWeight:val?600:400, color:val?"#111111":C.inkMid }}>{lbl}</span>\n              </label>\n            ))}\n            <label style={{ display:"flex", alignItems:"center", gap:6, cursor:"pointer", fontSize:11,\n              padding:"5px 10px", borderRadius:4, background:d.ent_inclCondPago?"#E8F4EE":"#F5F4F1",\n              border:`1px solid ${d.ent_inclCondPago?"#111111":"transparent"}` }}>\n              <input type="checkbox" checked={d.ent_inclCondPago??true} onChange={e => set("ent_inclCondPago", e.target.checked)}\n                style={{ accentColor:"#111111" }} />\n              <span style={{ fontWeight:d.ent_inclCondPago?600:400, color:d.ent_inclCondPago?"#111111":C.inkMid }}>ğŸ’° Condiciones de pago</span>\n            </label>\n            <label style={{ display:"flex", alignItems:"center", gap:6, cursor:"pointer", fontSize:11,\n              padding:"5px 10px", borderRadius:4, background:d.ent_inclGarantias?"#E8F4EE":"#F5F4F1",\n              border:`1px solid ${d.ent_inclGarantias?"#111111":"transparent"}` }}>\n              <input type="checkbox" checked={d.ent_inclGarantias??true} onChange={e => set("ent_inclGarantias", e.target.checked)}\n                style={{ accentColor:"#111111" }} />\n              <span style={{ fontWeight:d.ent_inclGarantias?600:400, color:d.ent_inclGarantias?"#111111":C.inkMid }}>ğŸ›¡ï¸ GarantÃ­as</span>\n            </label>\n          </div>\n        </div>\n      </Card>\n\n      {/* â•â•â•â•â•â•â•â•â•â•â• WORKFLOW DE APROBACIÃ“N (no-print) â•â•â•â•â•â•â•â•â•â•â• */}\n      <Card className="no-print" style={{ padding:0, marginBottom:16, overflow:"hidden" }}>\n        {/* Status bar */}\n        <div style={{ display:"flex", alignItems:"center", gap:12, padding:"14px 20px",\n          background: wfInfo.color + "12", borderBottom:`2px solid ${wfInfo.color}33` }}>\n          <span style={{ fontSize:22 }}>{wfInfo.icon}</span>\n          <div style={{ flex:1 }}>\n            <div style={{ fontSize:13, fontWeight:700, color:wfInfo.color }}>{wfInfo.label}</div>\n            <div style={{ fontSize:10, color:C.inkMid }}>{wfInfo.desc}</div>\n          </div>\n          <div style={{ textAlign:"right" }}>\n            <div style={{ fontSize:9, color:C.inkLight, textTransform:"uppercase", letterSpacing:1 }}>RevisiÃ³n</div>\n            <div style={{ fontSize:18, fontWeight:700, color:C.ink }}>{revision}</div>\n          </div>\n        </div>\n\n        {/* Workflow steps visualization */}\n        <div style={{ display:"flex", padding:"12px 20px", gap:0, overflowX:"auto" }}>\n          {[\n            { key:"borrador", lbl:"Borrador", icon:"ğŸ“" },\n            { key:"pendiente_aprobacion", lbl:"RevisiÃ³n interna", icon:"â³" },\n            { key:"aprobada_internamente", lbl:"Aprobada", icon:"âœ…" },\n            { key:"enviada", lbl:"Enviada", icon:"ğŸ“¨" },\n            { key:"aprobada_cliente", lbl:"Aceptada", icon:"ğŸ‰" },\n          ].map((step, i, arr) => {\n            const states = ["borrador","pendiente_aprobacion","aprobada_internamente","enviada","aprobada_cliente"];\n            const currentIdx = states.indexOf(wfEstado);\n            const stepIdx = states.indexOf(step.key);\n            const done = stepIdx <= currentIdx;\n            const active = step.key === wfEstado || (wfEstado === "devuelta_internamente" && step.key === "pendiente_aprobacion") || (wfEstado === "devuelta_cliente" && step.key === "enviada");\n            return (\n              <div key={step.key} style={{ display:"flex", alignItems:"center" }}>\n                <div style={{ display:"flex", flexDirection:"column", alignItems:"center", minWidth:70 }}>\n                  <div style={{ width:28, height:28, borderRadius:"50%", display:"flex", alignItems:"center", justifyContent:"center",\n                    background: done ? "#111111" : active ? "#D4840A" : "#E0E0E0",\n                    fontSize:13, transition:"all .2s" }}>\n                    {done ? <span style={{ color:"#fff", fontSize:11 }}>âœ“</span> : <span>{step.icon}</span>}\n                  </div>\n                  <span style={{ fontSize:8, fontWeight:600, color: done ? "#111111" : active ? "#D4840A" : "#999",\n                    marginTop:3, textAlign:"center", lineHeight:1.2 }}>{step.lbl}</span>\n                </div>\n                {i < arr.length - 1 && (\n                  <div style={{ width:30, height:2, background: stepIdx < currentIdx ? "#111111" : "#E0E0E0", margin:"0 2px", marginBottom:14 }}/>\n                )}\n              </div>\n            );\n          })}\n        </div>\n\n        {/* Actions panel */}\n        <div style={{ padding:"12px 20px 16px", borderTop:`1px solid ${C.border}` }}>\n          {/* User selector */}\n          <div style={{ display:"flex", gap:10, marginBottom:10, alignItems:"center" }}>\n            <span style={{ fontSize:9, fontWeight:600, color:C.inkLight, textTransform:"uppercase", letterSpacing:1 }}>Trabajando como:</span>\n            {USUARIOS_INTERNOS.map(u => (\n              <button key={u.id} onClick={() => { setWfUsuario(u.id); set("wf_usuario", u.id); }}\n                style={{ padding:"4px 10px", fontSize:10, fontWeight:600, cursor:"pointer",\n                  border:`1px solid ${wfUsuario===u.id ? "#111111" : C.border}`, borderRadius:4,\n                  background: wfUsuario===u.id ? "#E8F4EE" : "#fff",\n                  color: wfUsuario===u.id ? "#111111" : C.inkMid,\n                  fontFamily:"\'DM Sans\',sans-serif" }}>\n                {u.id === "david" ? "ğŸ‘¤" : "ğŸ‘©"} {u.nombre.split(" ")[0]}\n              </button>\n            ))}\n          </div>\n\n          {/* Comment field */}\n          {["pendiente_aprobacion","devuelta_internamente","devuelta_cliente"].includes(wfEstado) && (\n            <div style={{ marginBottom:10 }}>\n              <input value={wfComment} onChange={e => setWfComment(e.target.value)}\n                placeholder={wfEstado === "pendiente_aprobacion" ? "Observaciones de aprobaciÃ³n (opcional)..." : "Comentarios sobre los cambios realizados..."}\n                style={{ width:"100%", padding:"8px 12px", border:`1px solid ${C.border}`, borderRadius:4,\n                  fontSize:12, fontFamily:"\'DM Sans\',sans-serif", background:"#fff" }}/>\n            </div>\n          )}\n\n          {/* Action buttons per state */}\n          <div style={{ display:"flex", gap:8, flexWrap:"wrap" }}>\n            {wfEstado === "borrador" && (\n              <button onClick={() => wfAction("solicitar")}\n                style={{ display:"flex", alignItems:"center", gap:6, padding:"8px 16px",\n                  background:"#D4840A", color:"#fff", border:"none", borderRadius:5,\n                  cursor:"pointer", fontSize:12, fontWeight:600, fontFamily:"\'DM Sans\',sans-serif" }}>\n                <Send size={13}/> Solicitar aprobaciÃ³n a {wfAprobador?.nombre?.split(" ")[0]}\n              </button>\n            )}\n            {wfEstado === "pendiente_aprobacion" && wfUsuario === wfAprobador?.id && (<>\n              <button onClick={() => wfAction("aprobar_interno")}\n                style={{ display:"flex", alignItems:"center", gap:6, padding:"8px 16px",\n                  background:"#111111", color:"#fff", border:"none", borderRadius:5,\n                  cursor:"pointer", fontSize:12, fontWeight:600, fontFamily:"\'DM Sans\',sans-serif" }}>\n                <Check size={13}/> Aprobar\n              </button>\n              <button onClick={() => { if(!wfComment) { alert("Escribe las observaciones"); return; } wfAction("devolver_interno"); }}\n                style={{ display:"flex", alignItems:"center", gap:6, padding:"8px 16px",\n                  background:"#FFF8E7", color:"#D4840A", border:"1px solid #D4840A33", borderRadius:5,\n                  cursor:"pointer", fontSize:12, fontWeight:600, fontFamily:"\'DM Sans\',sans-serif" }}>\n                <RotateCcw size={13}/> Devolver con observaciones\n              </button>\n            </>)}\n            {wfEstado === "pendiente_aprobacion" && wfUsuario !== wfAprobador?.id && (\n              <div style={{ fontSize:11, color:"#D4840A", padding:"8px 0" }}>\n                â³ Esperando que <strong>{wfAprobador?.nombre}</strong> apruebe. Cambia a su usuario para simular la aprobaciÃ³n.\n              </div>\n            )}\n            {wfEstado === "devuelta_internamente" && (\n              <button onClick={() => wfAction("solicitar")}\n                style={{ display:"flex", alignItems:"center", gap:6, padding:"8px 16px",\n                  background:"#D4840A", color:"#fff", border:"none", borderRadius:5,\n                  cursor:"pointer", fontSize:12, fontWeight:600, fontFamily:"\'DM Sans\',sans-serif" }}>\n                <Send size={13}/> Re-solicitar aprobaciÃ³n\n              </button>\n            )}\n            {wfEstado === "aprobada_internamente" && (<>\n              <button onClick={async () => {\n                const p = await wfEnviarCliente();\n                navigator.clipboard?.writeText(p.portalUrl);\n                alert(`âœ… Portal creado y URL copiada.\\n\\nEnvÃ­a este link al cliente:\\n${p.portalUrl}`);\n              }}\n                style={{ display:"flex", alignItems:"center", gap:6, padding:"8px 16px",\n                  background:"#3B3B3B", color:"#fff", border:"none", borderRadius:5,\n                  cursor:"pointer", fontSize:12, fontWeight:600, fontFamily:"\'DM Sans\',sans-serif" }}>\n                <Send size={13}/> Enviar al cliente (crear portal)\n              </button>\n              <button onClick={downloadPDF}\n                style={{ display:"flex", alignItems:"center", gap:6, padding:"8px 16px",\n                  background:"#111", color:"#fff", border:"none", borderRadius:5,\n                  cursor:"pointer", fontSize:12, fontWeight:600, fontFamily:"\'DM Sans\',sans-serif" }}>\n                <Download size={13}/> Descargar PDF\n              </button>\n            </>)}\n            {wfEstado === "enviada" && (\n              <div style={{ fontSize:11, color:"#3B3B3B", padding:"8px 0" }}>\n                ğŸ“¨ Esperando respuesta del cliente. Portal activo.\n                {d.wf_lastPortalUrl && (\n                  <button onClick={() => navigator.clipboard?.writeText(d.wf_lastPortalUrl).then(() => alert("âœ… URL copiada"))}\n                    style={{ marginLeft:8, background:"#F0F0F0", border:"1px solid #3B3B3B33", borderRadius:3,\n                      padding:"3px 8px", fontSize:10, cursor:"pointer", color:"#3B3B3B", fontWeight:600, fontFamily:"\'DM Sans\',sans-serif" }}>\n                    ğŸ“‹ Copiar URL portal\n                  </button>\n                )}\n              </div>\n            )}\n            {wfEstado === "devuelta_cliente" && (<>\n              <button onClick={() => { set("revision", revision + 1); wfAction("solicitar"); }}\n                style={{ display:"flex", alignItems:"center", gap:6, padding:"8px 16px",\n                  background:"#D4840A", color:"#fff", border:"none", borderRadius:5,\n                  cursor:"pointer", fontSize:12, fontWeight:600, fontFamily:"\'DM Sans\',sans-serif" }}>\n                <RotateCcw size={13}/> Crear Rev.{revision+1} y solicitar aprobaciÃ³n\n              </button>\n            </>)}\n            {wfEstado === "aprobada_cliente" && (\n              <div style={{ fontSize:12, color:"#111111", padding:"8px 0", fontWeight:600 }}>\n                ğŸ‰ Â¡Oferta ganada! El cliente aceptÃ³ la propuesta.\n              </div>\n            )}\n            {wfEstado === "rechazada_cliente" && (\n              <div style={{ fontSize:12, color:"#B91C1C", padding:"8px 0" }}>\n                âŒ El cliente rechazÃ³ la propuesta. {wfHistory.filter(h=>h.accion==="rechazar_cliente").slice(-1)[0]?.comentarios && (\n                  <span style={{ fontStyle:"italic" }}>Motivo: "{wfHistory.filter(h=>h.accion==="rechazar_cliente").slice(-1)[0]?.comentarios}"</span>\n                )}\n              </div>\n            )}\n\n            {/* Always show PDF download */}\n            {!["aprobada_internamente"].includes(wfEstado) && (\n              <button onClick={downloadPDF}\n                style={{ display:"flex", alignItems:"center", gap:6, padding:"8px 14px",\n                  background:"transparent", color:C.inkMid, border:`1px solid ${C.border}`, borderRadius:5,\n                  cursor:"pointer", fontSize:11, fontWeight:500, fontFamily:"\'DM Sans\',sans-serif" }}>\n                <Download size={12}/> PDF\n              </button>\n            )}\n          </div>\n        </div>\n\n        {/* History timeline */}\n        {wfHistory.length > 0 && (\n          <div style={{ padding:"0 20px 14px", borderTop:`1px solid ${C.border}`, marginTop:0 }}>\n            <details>\n              <summary style={{ fontSize:10, fontWeight:600, color:C.inkLight, cursor:"pointer", padding:"10px 0 4px",\n                textTransform:"uppercase", letterSpacing:1 }}>\n                Historial ({wfHistory.length} acciones)\n              </summary>\n              <div style={{ maxHeight:200, overflowY:"auto" }}>\n                {wfHistory.slice().reverse().map((h, i) => {\n                  const ACCION_LBL = {\n                    solicitar:"SolicitÃ³ aprobaciÃ³n", aprobar_interno:"AprobÃ³ internamente",\n                    devolver_interno:"DevolviÃ³ con observaciones", enviar:"EnviÃ³ al cliente",\n                    reenviar:"Re-enviÃ³ al cliente", aprobar_cliente:"Cliente aprobÃ³",\n                    rechazar_cliente:"Cliente rechazÃ³", devolver_cliente:"Cliente devolviÃ³"\n                  };\n                  return (\n                    <div key={h.id||i} style={{ display:"flex", gap:8, padding:"5px 0", borderBottom:`1px solid #F5F5F5`, fontSize:10 }}>\n                      <div style={{ minWidth:100, color:C.inkLight }}>{new Date(h.fecha).toLocaleString("es-CO",{day:"2-digit",month:"short",hour:"2-digit",minute:"2-digit"})}</div>\n                      <div style={{ flex:1 }}>\n                        <span style={{ fontWeight:600 }}>{h.por?.nombre?.split(" ")[0] || "â€”"}</span>\n                        <span style={{ color:C.inkMid }}> Â· {ACCION_LBL[h.accion] || h.accion}</span>\n                        {h.comentarios && <div style={{ color:"#D4840A", fontStyle:"italic", marginTop:2 }}>ğŸ’¬ {h.comentarios}</div>}\n                      </div>\n                      <div style={{ fontSize:9, color:C.inkLight }}>Rev.{h.revision}</div>\n                    </div>\n                  );\n                })}\n              </div>\n            </details>\n          </div>\n        )}\n\n        {/* Portal history */}\n        {wfPortals.length > 0 && (\n          <div style={{ padding:"0 20px 14px", borderTop:`1px solid ${C.border}` }}>\n            <details>\n              <summary style={{ fontSize:10, fontWeight:600, color:C.inkLight, cursor:"pointer", padding:"10px 0 4px",\n                textTransform:"uppercase", letterSpacing:1 }}>\n                Portales cliente ({wfPortals.length})\n              </summary>\n              {wfPortals.map((p, i) => (\n                <div key={p.token||i} style={{ display:"flex", gap:8, padding:"5px 0", borderBottom:`1px solid #F5F5F5`, fontSize:10, alignItems:"center" }}>\n                  <span style={{ fontSize:14 }}>{p.estado==="aprobada"?"âœ…":p.estado==="rechazada"?"âŒ":p.estado==="devuelta"?"ğŸ”„":"ğŸ“¨"}</span>\n                  <div style={{ flex:1 }}>\n                    <div style={{ fontWeight:600 }}>Rev.{p.revision} Â· {new Date(p.fechaCreacion).toLocaleDateString("es-CO")}</div>\n                    <div style={{ color:C.inkLight }}>{p.clienteEmail || p.clienteNombre}</div>\n                  </div>\n                  <span style={{ fontSize:9, fontWeight:600, padding:"2px 6px", borderRadius:3,\n                    color: p.estado==="pendiente"?"#3B3B3B":p.estado==="aprobada"?"#111111":"#B91C1C",\n                    background: p.estado==="pendiente"?"#F0F0F0":p.estado==="aprobada"?"#E8F4EE":"#FAE8E8" }}>\n                    {p.estado}\n                  </span>\n                </div>\n              ))}\n            </details>\n          </div>\n        )}\n      </Card>\n\n      {/* â•â•â•â•â•â•â•â•â•â•â• PRINT SECTION HEADER â•â•â•â•â•â•â•â•â•â•â• */}\n      <div className="p-hdr print-page-break">\n        <div>\n          <div style={{ fontWeight:700, fontSize:13, letterSpacing:4 }}>HABITARIS</div>\n          <div style={{ fontSize:7, letterSpacing:2, color:"#999", textTransform:"uppercase" }}>Arquitectura Â· Interiorismo Â· ConstrucciÃ³n</div>\n        </div>\n        <div style={{ textAlign:"right" }}>\n          <div style={{ fontSize:10, fontWeight:700 }}>{titulo}</div>\n          <div style={{ fontSize:8, color:"#666" }}>{refOferta} Â· {fechaDoc}</div>\n        </div>\n      </div>\n\n      {/* â•â•â•â•â•â•â•â•â•â•â• PORTADA (screen only) â•â•â•â•â•â•â•â•â•â•â• */}\n      <div className="no-print" style={{ display:"grid", gridTemplateColumns:"2fr 1fr", gap:16, marginBottom:16 }}>\n        <Card style={{ padding:22 }}>\n          <STitle t="Portada" s="Datos visibles en la portada del documento" />\n          <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:12, marginTop:12 }}>\n            <div>{label("Tipo de documento")}{inp("titulo", isObra ? "PRESUPUESTO DE EJECUCIÃ“N" : "PROPUESTA DE DISEÃ‘O")}</div>\n            <div>{label("NÂ° Oferta")}{inp("ref", d.codigoOferta || "")}</div>\n            <div>{label("Cliente")}{inp("cliente", d.cliente || "")}</div>\n            <div>{label("Fecha")}{inp("fecha", d.fechaOferta || today())}</div>\n          </div>\n        </Card>\n        <Card style={{ padding:22, background:C.ink, color:"#fff", position:"relative" }}>\n          <div style={{ position:"absolute", top:8, right:10, background:"rgba(255,255,255,0.15)", padding:"2px 8px", borderRadius:3, fontSize:8, fontWeight:600, color:"rgba(255,255,255,0.5)", textTransform:"uppercase", letterSpacing:0.8 }}>Solo uso interno</div>\n          <p style={{ fontSize:9, letterSpacing:1.5, textTransform:"uppercase", color:"rgba(255,255,255,0.4)", margin:"0 0 6px" }}>PVP Total</p>\n          <p style={{ fontFamily:"\'DM Sans\',sans-serif", fontSize:32, fontWeight:700, color:"#fff", margin:"0 0 4px", letterSpacing:-1 }}>{fmt(r.PVP_IVA)}</p>\n          <p style={{ fontSize:10, color:"rgba(255,255,255,0.4)", margin:"0 0 16px" }}>{isObra ? "IVA sobre utilidad" : "IVA incluido"} Â· {d.divisa||"COP"}</p>\n          <div style={{ borderTop:"1px solid rgba(255,255,255,0.15)", paddingTop:12 }}>\n            {[["PVP sin IVA", fmt(r.PVP)],\n              [isObra ? `IVA (${pct(d.tarifaIVA)} Ã— U ${pct(r.U)})` : `IVA ${pct(d.tarifaIVA)}`, fmt(r.IVA)],\n              ...(r.ret > 0 ? [["Retenciones (flujo)", "-"+fmt(r.ret)]] : []),\n            ].map(([l,v])=>(\n              <div key={l} style={{ display:"flex", justifyContent:"space-between", fontSize:11, marginBottom:4 }}>\n                <span style={{ color:"rgba(255,255,255,0.5)" }}>{l}</span>\n                <span style={{ fontFamily:"\'DM Mono\',monospace", color:"rgba(255,255,255,0.8)" }}>{v}</span>\n              </div>\n            ))}\n          </div>\n        </Card>\n      </div>\n\n      {/* â•â•â•â•â•â•â•â•â•â•â• ALCANCE â•â•â•â•â•â•â•â•â•â•â• */}\n      <div className="print-section" style={{ marginBottom:16 }}>\n        <Card style={{ padding:22 }}>\n          <STitle t="Alcance del servicio" s="" />\n          {d.alcanceTexto && (\n            <div className="no-print" style={{ background:"#E8F4EE", borderRadius:4, padding:"8px 12px", fontSize:10, color:"#111111", marginTop:6, marginBottom:6, display:"flex", justifyContent:"space-between", alignItems:"center" }}>\n              <span>ğŸ“‹ Hay un alcance configurado en la pestaÃ±a General</span>\n              <button onClick={()=>set("ent_alcance", d.alcanceTexto)}\n                style={{ background:"#111111", color:"#fff", border:"none", borderRadius:3, padding:"3px 10px", fontSize:10, fontWeight:600, cursor:"pointer", fontFamily:"\'DM Sans\',sans-serif" }}>\n                Usar plantilla\n              </button>\n            </div>\n          )}\n          <div style={{ marginTop:10 }}>\n            {plabel("DescripciÃ³n del alcance")}\n            {ta("alcance", d.alcanceTexto || (isObra\n              ? `El presente alcance comprende la ejecuciÃ³n integral del proyecto de diseÃ±o previamente aprobado, incluyendo construcciÃ³n, suministro de materiales, acabados e interventorÃ­a, garantizando coherencia entre diseÃ±o, presupuesto y resultado final.`\n              : `DiseÃ±o y desarrollo integral del proyecto ${d.proyecto||""} ubicado en ${d.ubicacion||""}. Incluye levantamiento, conceptualizaciÃ³n, desarrollo de planos tÃ©cnicos y acompaÃ±amiento en la ejecuciÃ³n.`), 5)}\n          </div>\n          {isObra && (\n            <div style={{ marginTop:14 }}>\n              {plabel("Fases del proyecto")}\n              {ta("fases", "- Firma de contrato\\n- RecepciÃ³n de anticipo\\n- AprobaciÃ³n de planos tÃ©cnicos\\n- AprobaciÃ³n de acabados\\n- ValidaciÃ³n formal de materiales y especificaciones\\n- Firma de acta de inicio de obra\\n- Inicio de obra\\n- RecepciÃ³n de obra\\n- Firma de acta final", 6)}\n            </div>\n          )}\n          <div style={{ marginTop:14 }}>\n            {plabel("Exclusiones")}\n            {ta("exclusiones", isObra\n              ? "Esta propuesta no incluye, salvo que se acuerde por escrito, ejecuciones adicionales a las contempladas en los diseÃ±os aprobados.\\n\\n- Licencias y permisos de construcciÃ³n\\n- Obra civil de estructura y cimentaciÃ³n no contemplada en diseÃ±os\\n- Suministro e instalaciÃ³n de electrodomÃ©sticos\\n- GestiÃ³n de condominio o administraciÃ³n\\n- Mudanzas y trasteos\\n- DiseÃ±o o rediseÃ±o arquitectÃ³nico (ya aprobado previamente)\\n\\nTodos los entregables se comparten exclusivamente en formato digital."\n              : "Esta propuesta no incluye, salvo que se acuerde por escrito:\\n\\n- Licencias y permisos de construcciÃ³n\\n- Obra civil de estructura y cimentaciÃ³n\\n- Suministro e instalaciÃ³n de electrodomÃ©sticos\\n- GestiÃ³n de condominio o administraciÃ³n\\n- EjecuciÃ³n de obra o interventorÃ­a\\n- Renders 3D fotorrealistas (se cotizan aparte)\\n\\nTodos los entregables se comparten exclusivamente en formato digital.", 6)}\n          </div>\n        </Card>\n      </div>\n\n      {/* â•â•â•â•â•â•â•â•â•â•â• PRESUPUESTO â•â•â•â•â•â•â•â•â•â•â• */}\n      <div className="print-page-break print-section">\n        {/* Print header repeat */}\n        <div className="p-hdr">\n          <div><div style={{ fontWeight:700, fontSize:13, letterSpacing:4 }}>HABITARIS</div></div>\n          <div style={{ textAlign:"right" }}><div style={{ fontSize:10, fontWeight:700 }}>{titulo}</div><div style={{ fontSize:8, color:"#666" }}>{refOferta} Â· {fechaDoc}</div></div>\n        </div>\n        <Card style={{ padding:0, overflow:"hidden", marginBottom:16 }}>\n          <div style={{ padding:"14px 20px", borderBottom:`1px solid ${C.border}`, display:"flex", justifyContent:"space-between", alignItems:"center" }}>\n            <STitle t="Presupuesto" s={`Vista: ${nivelDetalle==="detallado"?"Detallado":nivelDetalle==="capitulos"?"Por capÃ­tulos":"Total Ãºnico"}`} />\n          </div>\n          {nivelDetalle === "total" ? (\n            <table style={{ width:"100%", borderCollapse:"collapse", fontSize:12 }}>\n              <thead><tr style={{ background:"#FFFFFF" }}>\n                {["Item","DescripciÃ³n","Total"].map(h=>(\n                  <th key={h} style={{ padding:"9px 14px", textAlign:h==="Total"?"right":"left",\n                    fontSize:9, fontWeight:600, color:C.inkLight, textTransform:"uppercase", letterSpacing:0.8 }}>{h}</th>\n                ))}\n              </tr></thead>\n              <tbody>\n                <tr style={{ borderTop:`1px solid ${C.border}` }}>\n                  <td style={{ padding:"10px 14px" }}>1</td>\n                  <td style={{ padding:"10px 14px" }}>{getText("descTotal", isObra\n                    ? `Reforma integral de espacios segÃºn diseÃ±o, incluye obras civiles, carpinterÃ­as y acabados segÃºn diseÃ±o aprobado.`\n                    : `DiseÃ±o integral â€” ${d.proyecto||"proyecto"}`)}</td>\n                  <td style={{ padding:"10px 14px", textAlign:"right", fontFamily:"\'DM Mono\',monospace", fontWeight:700 }}>{fmt(r.PVP)}</td>\n                </tr>\n                <tr style={{ background:"#F5F4F1" }}>\n                  <td colSpan={2} style={{ padding:"8px 14px", fontSize:11, color:C.inkMid }}>{isObra ? `IVA sobre la utilidad` : `IVA ${pct(d.tarifaIVA)}`}</td>\n                  <td style={{ padding:"8px 14px", textAlign:"right", fontFamily:"\'DM Mono\',monospace" }}>{fmt(r.IVA)}</td>\n                </tr>\n                <tr style={{ background:C.ink }}>\n                  <td colSpan={2} style={{ padding:"12px 14px", fontWeight:700, color:"#fff", fontSize:14 }}>Valor total</td>\n                  <td style={{ padding:"12px 14px", textAlign:"right", fontFamily:"\'DM Mono\',monospace", fontWeight:700, fontSize:16, color:"#fff" }}>{fmt(r.PVP_IVA)}</td>\n                </tr>\n              </tbody>\n            </table>\n          ) : nivelDetalle === "capitulos" ? (\n            <table style={{ width:"100%", borderCollapse:"collapse", fontSize:12 }}>\n              <thead><tr style={{ background:"#FFFFFF" }}>\n                {["Item","DescripciÃ³n","Total"].map(h=>(\n                  <th key={h} style={{ padding:"9px 14px", textAlign:h==="Total"?"right":"left",\n                    fontSize:9, fontWeight:600, color:C.inkLight, textTransform:"uppercase", letterSpacing:0.8 }}>{h}</th>\n                ))}\n              </tr></thead>\n              <tbody>\n                {capTotals.map((cap, i) => (\n                  <tr key={cap.id} style={{ borderTop:`1px solid ${C.border}` }}>\n                    <td style={{ padding:"10px 14px" }}>{i+1}</td>\n                    <td style={{ padding:"10px 14px", fontWeight:600 }}>{cap.nombre||"CapÃ­tulo "+(i+1)}</td>\n                    <td style={{ padding:"10px 14px", textAlign:"right", fontFamily:"\'DM Mono\',monospace", fontWeight:600 }}>{fmt(cap.total)}</td>\n                  </tr>\n                ))}\n                <tr style={{ borderTop:`2px solid ${C.ink}`, background:"#F5F4F1" }}>\n                  <td colSpan={2} style={{ padding:"10px 14px", fontWeight:700 }}>Subtotal</td>\n                  <td style={{ padding:"10px 14px", textAlign:"right", fontFamily:"\'DM Mono\',monospace", fontWeight:700 }}>{fmt(r.PVP)}</td>\n                </tr>\n                <tr style={{ background:"#F5F4F1" }}>\n                  <td colSpan={2} style={{ padding:"6px 14px", fontSize:11, color:C.inkMid }}>{isObra ? `IVA sobre la utilidad` : `IVA ${pct(d.tarifaIVA)}`}</td>\n                  <td style={{ padding:"6px 14px", textAlign:"right", fontFamily:"\'DM Mono\',monospace" }}>{fmt(r.IVA)}</td>\n                </tr>\n                <tr style={{ background:C.ink }}>\n                  <td colSpan={2} style={{ padding:"12px 14px", fontWeight:700, color:"#fff", fontSize:14 }}>Valor total</td>\n                  <td style={{ padding:"12px 14px", textAlign:"right", fontFamily:"\'DM Mono\',monospace", fontWeight:700, fontSize:16, color:"#fff" }}>{fmt(r.PVP_IVA)}</td>\n                </tr>\n              </tbody>\n            </table>\n          ) : (\n            <table style={{ width:"100%", borderCollapse:"collapse", fontSize:12 }}>\n              <thead><tr style={{ background:"#FFFFFF" }}>\n                {["Ref.","DescripciÃ³n","Und","Cant.","PU","Total"].map(h=>(\n                  <th key={h} style={{ padding:"9px 14px", textAlign:h==="Total"||h==="PU"?"right":"left",\n                    fontSize:9, fontWeight:600, color:C.inkLight, textTransform:"uppercase", letterSpacing:0.8 }}>{h}</th>\n                ))}\n              </tr></thead>\n              <tbody>\n                {borLineas.map((l, i) => {\n                  if (l.esCapitulo) return (\n                    <tr key={l.id} style={{ background:C.accentBg, borderTop:`2px solid ${C.border}` }}>\n                      <td colSpan={6} style={{ padding:"8px 14px", fontWeight:700, fontSize:12, color:C.ink, textTransform:"uppercase" }}>{l.nombre || l.tipo}</td>\n                    </tr>\n                  );\n                  const venta = l.precioCD ? calcPUVentaLinea(l.precioCD, l.cantidad||1, d) : null;\n                  return (\n                    <tr key={l.id} style={{ borderTop:`1px solid ${C.border}` }}>\n                      <td style={{ padding:"8px 14px", color:C.inkLight, fontSize:11 }}>{l.codigo||String(i+1).padStart(2,"0")}</td>\n                      <td style={{ padding:"8px 14px" }}>{l.descripcion||"â€”"}</td>\n                      <td style={{ padding:"8px 14px", color:C.inkMid }}>{l.unidad||"Gl"}</td>\n                      <td style={{ padding:"8px 14px", color:C.inkMid, textAlign:"right" }}>{l.cantidad||1}</td>\n                      <td style={{ padding:"8px 14px", textAlign:"right", fontFamily:"\'DM Mono\',monospace" }}>{venta ? fmt(venta.puVenta) : "â€”"}</td>\n                      <td style={{ padding:"8px 14px", textAlign:"right", fontFamily:"\'DM Mono\',monospace", fontWeight:600 }}>{venta ? fmt(venta.totalVenta) : "â€”"}</td>\n                    </tr>\n                  );\n                })}\n                <tr style={{ borderTop:`2px solid ${C.ink}`, background:"#F5F4F1" }}>\n                  <td colSpan={5} style={{ padding:"10px 14px", fontWeight:700 }}>Subtotal</td>\n                  <td style={{ padding:"10px 14px", textAlign:"right", fontFamily:"\'DM Mono\',monospace", fontWeight:700 }}>{fmt(r.PVP)}</td>\n                </tr>\n                <tr style={{ background:"#F5F4F1" }}>\n                  <td colSpan={5} style={{ padding:"6px 14px", fontSize:11, color:C.inkMid }}>{isObra ? `IVA sobre la utilidad` : `IVA ${pct(d.tarifaIVA)}`}</td>\n                  <td style={{ padding:"6px 14px", textAlign:"right", fontFamily:"\'DM Mono\',monospace" }}>{fmt(r.IVA)}</td>\n                </tr>\n                <tr style={{ background:C.ink }}>\n                  <td colSpan={5} style={{ padding:"12px 14px", fontWeight:700, color:"#fff", fontSize:14 }}>Valor total</td>\n                  <td style={{ padding:"12px 14px", textAlign:"right", fontFamily:"\'DM Mono\',monospace", fontWeight:700, fontSize:16, color:"#fff" }}>{fmt(r.PVP_IVA)}</td>\n                </tr>\n              </tbody>\n            </table>\n          )}\n        </Card>\n      </div>\n\n      {/* â•â•â•â•â•â•â•â•â•â•â• CONDICIONES + PLAZO â•â•â•â•â•â•â•â•â•â•â• */}\n      <div className="print-page-break print-section" style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:16, marginBottom:16 }}>\n        <Card style={{ padding:22 }}>\n          <STitle t="Formas de pago" s="" />\n          <div style={{ marginTop:10 }}>\n            {ta("condPago", [\n              `${Math.round((d.condPct1??0.30)*100)}% de anticipo`,\n              `${Math.round((d.condPct2??0.30)*100)}% a la mitad de ejecuciÃ³n del proyecto`,\n              ...(condPct4 > 0 ? [`${Math.round((d.condPct3??0.30)*100)}% a la entrega / acta de recepciÃ³n`, `${Math.round(condPct4*100)}% retenciÃ³n a 30 dÃ­as`] : [`${Math.round((d.condPct3??0.30)*100)}% al acta de recepciÃ³n`]),\n            ].join("\\n"), 5)}\n          </div>\n          <div style={{ marginTop:10 }}>\n            {plabel("Medios de pago")}\n            {inp("medioPago", d.medioPago==="PSE" ? "Link PSE" : d.medioPago==="Tarjeta" ? "Pago con tarjeta (pasarela online)" : "Transferencia bancaria")}\n          </div>\n        </Card>\n        <Card style={{ padding:22 }}>\n          <STitle t="Plazo y garantÃ­as" s="" />\n          <div style={{ marginTop:10 }}>\n            {plabel("Plazo de ejecuciÃ³n")}\n            {inp("plazo", getText("duracion", "__ semanas desde la firma de acta de inicio"))}\n            <div style={{ marginTop:10 }}>\n              {plabel("GarantÃ­as")}\n              {ta("garantias", "- GarantÃ­a de obra: 1 aÃ±o sobre defectos de ejecuciÃ³n\\n- GarantÃ­a de materiales: segÃºn fabricante\\n- PÃ³liza todo riesgo durante la ejecuciÃ³n", 4)}\n            </div>\n          </div>\n        </Card>\n      </div>\n\n      {/* â•â•â•â•â•â•â•â•â•â•â• TÃ‰RMINOS â•â•â•â•â•â•â•â•â•â•â• */}\n      <div className="print-section" style={{ marginBottom:16 }}>\n        <Card style={{ padding:22 }}>\n          <STitle t="TÃ©rminos y condiciones" s="" />\n          <div style={{ marginTop:10 }}>\n            {ta("terminos",\n              "- Vigencia: La propuesta tiene una validez de 20 dÃ­as calendario desde la fecha de envÃ­o.\\n" +\n              "- Moneda: Pesos colombianos (COP).\\n" +\n              "- AprobaciÃ³n: Se considera aceptada al recibir confirmaciÃ³n escrita y el pago del anticipo.\\n" +\n              "- FormalizaciÃ³n: La relaciÃ³n contractual se considerarÃ¡ establecida mediante la firma de un contrato u orden de servicio que incorpore esta propuesta.\\n" +\n              "- Pago inicial: El inicio de los trabajos estarÃ¡ condicionado al cumplimiento de todas las condiciones de inicio.\\n" +\n              "- Reajustes: Los plazos y valores podrÃ¡n ser modificados en funciÃ³n de nuevos requerimientos o cambios en el alcance original.", 8)}\n          </div>\n          <div style={{ marginTop:14 }}>\n            {plabel("Nota legal")}\n            {ta("notaLegal",\n              "Esta propuesta tiene carÃ¡cter informativo y comercial. No constituye, por sÃ­ sola, un contrato. La relaciÃ³n contractual entre las partes solo se considerarÃ¡ establecida mediante la firma de un contrato, orden de servicio u otro documento que incorpore esta propuesta como anexo o referencia.\\n\\n" +\n              "La informaciÃ³n contenida en esta propuesta es confidencial y de uso exclusivo del cliente. No podrÃ¡ ser reproducida, compartida ni utilizada con fines comerciales o de ejecuciÃ³n por terceros sin autorizaciÃ³n previa y por escrito de Habitaris S.A.S.", 5)}\n          </div>\n        </Card>\n      </div>\n\n      {/* â•â•â•â•â•â•â•â•â•â•â• FIRMA â•â•â•â•â•â•â•â•â•â•â• */}\n      <div className="print-page-break print-section" style={{ marginBottom:16 }}>\n        {/* Print header */}\n        <div className="p-hdr">\n          <div><div style={{ fontWeight:700, fontSize:13, letterSpacing:4 }}>HABITARIS</div></div>\n          <div style={{ textAlign:"right" }}><div style={{ fontSize:10, fontWeight:700 }}>{titulo}</div><div style={{ fontSize:8, color:"#666" }}>{refOferta} Â· {fechaDoc}</div></div>\n        </div>\n        <Card style={{ padding:22 }}>\n          <STitle t="Firma de aceptaciÃ³n" s="" />\n          <div style={{ display:"grid", gridTemplateColumns:"1fr 1fr", gap:16, marginTop:14 }}>\n            <div>\n              {plabel("Representante Habitaris")}\n              <div style={{ border:`1px solid ${C.border}`, borderRadius:4, padding:"10px 12px", background:"#F5F4F1" }}>\n                <div style={{ fontWeight:700, fontSize:13 }}>{representante}</div>\n                <div style={{ fontSize:11, color:C.inkMid }}>{cargo}</div>\n                <div style={{ fontSize:10, color:C.inkLight, marginTop:4 }}>Habitaris S.A.S Â· NIT 901.922.136-8</div>\n              </div>\n              {getText("elaboradoPor","") && (\n                <div style={{ marginTop:8 }}>\n                  {plabel("Elaborado por")}\n                  <div style={{ fontSize:12 }}>{getText("elaboradoPor","")}</div>\n                  {getText("elaboradoPorCargo","") && <div style={{ fontSize:11, color:C.inkMid }}>{getText("elaboradoPorCargo","")}</div>}\n                </div>\n              )}\n              <div className="no-print" style={{ marginTop:8 }}>\n                {label("Elaborado por (opcional)")}\n                {inp("elaboradoPor", "")}\n                {getText("elaboradoPor","") && (<>\n                  {label("Cargo")}\n                  {inp("elaboradoPorCargo", "")}\n                </>)}\n              </div>\n            </div>\n            <div>\n              {plabel("Firma del cliente")}\n              <div className="no-print">{inp("firmaC", d.cliente || "")}</div>\n              <div className="print-only" style={{ fontSize:12, marginTop:4 }}>{getText("firmaC", d.cliente || "")}</div>\n              <div style={{ borderBottom:"1px solid #999", marginTop:60, width:"80%" }}/>\n              <div style={{ fontSize:9, color:C.inkLight, marginTop:4 }}>Firma y sello de aceptaciÃ³n</div>\n              <div style={{ borderBottom:"1px solid #999", marginTop:30, width:"80%" }}/>\n              <div style={{ fontSize:9, color:C.inkLight, marginTop:4 }}>Fecha</div>\n            </div>\n          </div>\n        </Card>\n      </div>\n\n      {/* â•â•â•â•â•â•â•â•â•â•â• COMPARTIR (no-print) â•â•â•â•â•â•â•â•â•â•â• */}\n      <Card className="no-print" style={{ padding:16, background:"#F5F5F5" }}>\n        <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", flexWrap:"wrap", gap:8 }}>\n          <span style={{ fontSize:10, fontWeight:600, color:C.inkLight, textTransform:"uppercase", letterSpacing:1 }}>Compartir manualmente</span>\n          <div style={{ display:"flex", gap:6 }}>\n            <button onClick={() => {\n              const email = d.emailCliente || prompt("Email del cliente:");\n              if (email) {\n                const subject = encodeURIComponent(`${titulo} â€” ${d.proyecto||"Habitaris"}`);\n                const body = encodeURIComponent(`Estimado/a ${clienteNombre},\\n\\nAdjuntamos la propuesta para ${d.proyecto||"el proyecto"} por un valor de ${fmt(r.PVP_IVA)} (IVA incluido).\\n\\nQuedamos atentos a sus comentarios.\\n\\nCordialmente,\\n${representante}\\n${cargo}\\nHabitaris S.A.S`);\n                window.open(`mailto:${email}?subject=${subject}&body=${body}`);\n              }\n            }}\n              style={{ display:"flex", alignItems:"center", gap:4, padding:"6px 12px",\n                background:"#3B3B3B", color:"#fff", border:"none", borderRadius:4,\n                cursor:"pointer", fontSize:10, fontWeight:600, fontFamily:"\'DM Sans\',sans-serif" }}>\n              <Mail size={11}/> Email\n            </button>\n            <button onClick={() => {\n              const tel = d.telCliente || prompt("TelÃ©fono (con cÃ³digo de paÃ­s):");\n              if (tel) { const num = tel.replace(/[^0-9]/g,""); window.open(`https://wa.me/${num}?text=${encodeURIComponent(`Hola ${clienteNombre}, le envÃ­o la propuesta de ${d.proyecto||"Habitaris"} por ${fmt(r.PVP_IVA)} (IVA incluido). â€” ${representante}, Habitaris`)}`); }\n            }}\n              style={{ display:"flex", alignItems:"center", gap:4, padding:"6px 12px",\n                background:"#25D366", color:"#fff", border:"none", borderRadius:4,\n                cursor:"pointer", fontSize:10, fontWeight:600, fontFamily:"\'DM Sans\',sans-serif" }}>\n              <MessageCircle size={11}/> WhatsApp\n            </button>\n            <button onClick={() => { navigator.clipboard?.writeText(`${titulo} â€” ${refOferta} â€” ${clienteNombre} â€” PVP: ${fmt(r.PVP_IVA)}`); alert("âœ… Copiado"); }}\n              style={{ display:"flex", alignItems:"center", gap:4, padding:"6px 12px",\n                background:"transparent", color:"#555", border:`1px solid ${C.border}`, borderRadius:4,\n                cursor:"pointer", fontSize:10, fontWeight:500, fontFamily:"\'DM Sans\',sans-serif" }}>\n              <Copy size={11}/> Copiar\n            </button>\n          </div>\n        </div>\n      </Card>\n    </div>\n  );\n}\n\n\n/* â”€â”€â”€ ENCUESTAS ISO 9001 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */\nconst PREGUNTAS_SATISFACCION = [\n  { id:"q1", texto:"Â¿CÃ³mo califica la calidad del diseÃ±o entregado?", tipo:"estrellas" },\n  { id:"q2", texto:"Â¿Se cumplieron los plazos pactados?", tipo:"estrellas" },\n  { id:"q3", texto:"Â¿La comunicaciÃ³n con el equipo fue adecuada?", tipo:"estrellas" },\n  { id:"q4", texto:"Â¿El presupuesto final se ajustÃ³ al acordado?", tipo:"estrellas" },\n  { id:"q5", texto:"Â¿RecomendarÃ­a nuestros servicios? (NPS)", tipo:"nps" },\n  { id:"q6", texto:"Â¿QuÃ© podrÃ­amos mejorar?", tipo:"texto" },\n  { id:"q7", texto:"Comentarios adicionales", tipo:"texto" },\n];\n\nconst PREGUNTAS_PROVEEDOR = [\n  { id:"p1", texto:"Calidad del material / servicio entregado", tipo:"estrellas" },\n  { id:"p2", texto:"Cumplimiento de plazos de entrega", tipo:"estrellas" },\n  { id:"p3", texto:"RelaciÃ³n calidad/precio", tipo:"estrellas" },\n  { id:"p4", texto:"Facilidad de comunicaciÃ³n", tipo:"estrellas" },\n  { id:"p5", texto:"Â¿VolverÃ­a a contratar este proveedor?", tipo:"sino" },\n  { id:"p6", texto:"Observaciones", tipo:"texto" },\n];\n\n'
    
    c = c[:start] + old_tent_code + c[end:]
    changes += 1
    print(f"  âœ“ TEnt restored ({len(old_tent_code)} chars, replaced {end-start} chars)")

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# WRITE
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
with open(p, "w") as f: f.write(c)
print(f"\n{'='*50}")
print(f"  {changes} changes applied")
print(f"{'='*50}")
